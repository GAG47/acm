# å¹¶æŸ¥é›†

**åˆå§‹åŒ–**

~~~c++
int fa[MAX];
for (int i=1;i<=n;i++) fa[i]=i;
~~~

**find**æŸ¥è¯¢ã€‚æŸ¥æ‰¾æŸä¸ªæ•°å­—çš„æœ€æ—©ç¥–å…ˆï¼Œä»¥è¡¨ç¤ºå…¶æ‰€å±é›†åˆã€‚

~~~C++
int find(int s)
{
    if (fa[s]==s) return s;
    else return find(fa[s]);
}
~~~

**ä¼˜åŒ–æ–¹å¼**:

ç‰¹æ®Šæƒ…å†µä¸‹**æ ‘**ä¼šé€€åŒ–æˆ**é“¾è¡¨**ï¼Œåˆ™æ—¶é—´å¤æ‚åº¦ä» $O(logn)$ çº§å˜ä¸º $O(n)$ çº§ã€‚æ­¤æ—¶è®©æ•°å­—ç›´æ¥æŒ‡å‘å…¬å…±ç¥–å…ˆï¼Œå¯ä»¥å‡å°‘æŸ¥è¯¢æ—¶çš„è€—æ—¶ã€‚

~~~c++
int find(int s)
{
    return fa[s]==s?s:fa[s]=find(fa[s]);
}
~~~

**untie**åˆå¹¶ï¼š

~~~c++
void unite(int a,int b)
{
    int u=find(a),v=find(b);
    fa[u]=v;
    return;
}
~~~

ä¼˜åŒ–åï¼š**æŒ‰ç§©åˆå¹¶**

å°†æ·±åº¦è¾ƒå°çš„æ ‘ä½œä¸ºå¦ä¸€æ£µæ ‘çš„å­æ ‘ï¼Œå¯ä»¥ä½¿æ ‘æ›´å¹³è¡¡

~~~c++
int ra[MAX];

...
    
void unite(int a,int b)
{
    int u=find(a),v=find(b);
    if (ra[u] < ra[v]) fa[u]=v;
    else if (ra[u]>ra[v]) fa[v]=u;
    else if (ra[u]==ra[v] && u!=v){
        ra[u]++; fa[v]=u;
    }
    return;
}
~~~

å®Œæ•´çš„æ¿å­

~~~c++
int n, m, fa[MAXN], ra[MAXN];
void init() {
    for (int i = 1; i <= n; ++i) fa[i] = i;
}
int find(int s) 
{
    return (s==fa[s]? s:fa[s]=find(fa[s]));
}
void unite(int a, int b) 
{
    a = find(a), b = find(b);
    if (a == b) return;
    if (ra[a] > ra[b]) {
        fa[b] = a;
    } else {
        if (ra[a] == ra[b]) ra[b]++;
        fa[a] = b;
    }
}
bool query(int x, int y) {
    return find(x) == find(y);
}
~~~

**æ¿å­é¢˜**ï¼š
[D - Equals (atcoder.jp)](https://atcoder.jp/contests/arc097/tasks/arc097_b)   [P3367 ã€æ¨¡æ¿ã€‘å¹¶æŸ¥é›† - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3367)

---

## æ‹“å±•åŸŸå¹¶æŸ¥é›†

æ‹“å±•åŸŸå¹¶æŸ¥é›†ç›¸å¯¹äºä¸€èˆ¬çš„å¹¶æŸ¥é›†ï¼Œæœ€å¤§çš„ç‰¹ç‚¹æ˜¯å¼€äº†**å¤šå€**çš„ç©ºé—´ï¼Œä»¥è§£å†³æŸäº›å…ƒç´ ä¹‹é—´æ˜¯å¦å¯ä»¥åœ¨æ»¡è¶³æŸç§**ä¼ é€’å…³ç³»**ï¼ˆä¸€èˆ¬æ˜¯**äºŒå…ƒ**ï¼‰çš„æ¡ä»¶ä¸‹å½’ç±»åˆ°è‹¥å¹²ä¸ªé›†åˆä¸­ã€‚
ä»¥ç®€å•çš„äºŒå…ƒå…³ç³»ä¸ºä¾‹ï¼šå®šä¹‰ $<a,b>$ è¡¨ç¤º $a$ å’Œ $b$ ä¸èƒ½å†åŒä¸€ä¸ªé›†åˆä¸­çš„äºŒå…ƒå…³ç³»ï¼Œé‚£ä¹ˆæ‰€æœ‰ä¸ $a$ åŒé›†åˆçš„å…ƒç´ éƒ½ä¸èƒ½ä¸ $b$ åœ¨åŒä¸€ä¸ªé›†åˆï¼Œè€Œæ‰€æœ‰ä¸èƒ½ä¸ $a$ åœ¨åŒä¸€é›†åˆå†…çš„å…ƒç´ éƒ½å¯ä¸ $b$ åœ¨åŒä¸€é›†åˆã€‚é‚£æˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªå…ƒç´  $a+n$ ï¼ˆä¸€èˆ¬ $n$ ä¸ºå…ƒç´ ä¸ªæ•°ï¼‰ï¼Œä½¿å¾— $<a,a+n>$ å¿…ç„¶æˆç«‹ã€‚åŠ å…¥ç°åœ¨æœ‰ä¸€å¯¹å¯¹ç«‹å…³ç³» $<a,b>$ï¼Œåˆ™åªéœ€è¦å°† $b$ æ‰€åœ¨çš„é›†åˆä¸ $a+n$ æ‰€åœ¨çš„é›†åˆåˆå¹¶å³å¯è¡¨ç¤º $<a,b>$ã€‚
å¯ä»¥å¾—åˆ°ç»“è®ºï¼š**æ‹“å±•åŸŸå¹¶æŸ¥é›†å°†å…ƒç´ æ”¾åˆ°ä¸åŒçš„é›†åˆå†…ï¼Œé€šè¿‡é›†åˆä¹‹é—´çš„å…³ç³»æ¥è¡¨ç¤ºå…ƒç´ ä¹‹é—´çš„å…³ç³»ã€‚**

**ä¾‹é¢˜**
1ã€[å…³æŠ¼ç½ªçŠ¯ ](https://www.luogu.com.cn/problem/P1525)
**é¢˜æ„**ï¼šå°†æ‰€æœ‰å…ƒç´ åˆ†ä¸ºä¸¤ä¸ªé›†åˆï¼Œéƒ¨åˆ†å…ƒç´ åœ¨ä¸€ä¸ªé›†åˆæ—¶ä¼šç»™è¯¥çŠ¶æ€ä¸€ä¸ªä»£ä»· $f(a,b)$ï¼Œæ±‚æœ€å¤§ä»£ä»·çš„æœ€å°å€¼ã€‚
**é¢˜è§£**ï¼šå¯ä»¥ç›´æ¥ç”¨ä¸Šé¢ä¾‹å­çš„æƒ³æ³•è§£å‡ºï¼Œä¹Ÿå¯ä»¥ç”¨ç”¨ä¸€ä¸ªæ•°ç»„ç»´æŠ¤æ¯ä¸ªå…ƒç´ çš„ä¸Šä¸€ä¸ªæ•Œäººã€‚

~~~c++
bool query(int a, int b) {
    return find(a) == find(b);
}
void solve() {
    cin >> n >> m;
    init();
    for (int i = 0; i < m; ++i) cin >> th[i].a >> th[i].b >> th[i].c;
    sort(th, th + m); //ä»æœ€å¤§ä»£ä»·å¼€å§‹éå†
    for (int i = 0; i < m; ++i) {
        if (query(th[i].a, th[i].b) || query(th[i].a + n, th[i].b + n)) {
            cout << th[i].c;
            return;
        }
        merge(th[i].a, th[i].b + n);
        merge(th[i].a + n, th[i].b);
    }
    cout << 0;
}
~~~

2ã€[é£Ÿç‰©é“¾](https://www.luogu.com.cn/problem/P2024)
**é¢˜æ„**ï¼šç»™å‡ºä¸‰ä¸ªé›†åˆï¼Œä¸‰ä¸ªé›†åˆå†…çš„å…ƒç´ éƒ½æŒ‡å‘ä¸‹ä¸€ä¸ªé›†åˆå†…çš„å…ƒç´ ï¼Œç»™å‡ºå¤šä¸ªå…ƒç´ çš„æŒ‡å‘å…³ç³»ï¼Œæ±‚é‡Œé¢çŸ›ç›¾çš„ä¸ªæ•°ã€‚
**é¢˜è§£**ï¼šè¿™é“é¢˜æœ‰ä¸¤ç§è§£æ³•ï¼Œå…ˆä»‹ç»æ‹“å±•åŸŸå¹¶æŸ¥é›†çš„è§£æ³•:

~~~c++
//aåƒa+N a+nåƒa+2*n a+2*nåƒa+n
bool check(int opt, int u, int v)
{
	if (u > N || v > N) return false;
	if (opt == 1) {
		if (find(u + N) == find(v) || find(u + 2 * N) == find(v)) return false;
	}
	if (opt == 2) { //uåƒv
		if (find(u + 2 * N) == find(v) || find(u) == find(v)) return false;
	}
	return true;
}
void solve()
{
	cin >> N >> K;
	for (int i = 1; i <= N * 3; i++) fa[i] = i;
	for (int i = 1; i <= K; i++) {
		int opt, u, v;
		cin >> opt >> u >> v;
		if (!check(opt, u, v)) ans++;
		else {
			if (opt == 1) { //å‡å¦‚uä¸væ˜¯åŒç±» åˆ™uä¸vçš„å¤©æ•Œå’Œé£Ÿç‰©ä¹Ÿäº’ä¸ºåŒç±»
				unite(u, v);
				unite(N + u, N + v);
				unite(2 * N + u, 2 * N + v);
			}
			else if (opt == 2) {
				unite(u, 2 * N + v);
				unite(N + u, v);
				unite(2 * N + u, N + v);
			}
		}
	}
	cout << ans;
	return 0;
}
~~~

---

## å¸¦æƒå¹¶æŸ¥é›†

**å¸¦æƒå¹¶æŸ¥é›†**ç»“å±€çš„é—®é¢˜ä¸æ‹“å±•åŸŸå¹¶æŸ¥é›†ä¸€è‡´ï¼Œä½†æ˜¯ä¸åœ¨ç”¨é›†åˆçš„å…³ç³»è¡¨ç¤ºå…ƒç´ çš„å…³ç³»ï¼Œè€Œæ˜¯é€šè¿‡**å…ƒç´ å’Œé›†åˆçš„å…³ç³»é—´æ¥å¾—å‡ºå…ƒç´ ä¹‹é—´çš„å…³ç³»**ã€‚
åŒæ ·ä¸¾ä¸ªå¯¹ç«‹å…³ç³»çš„ä¾‹å­ã€‚ç°æœ‰ä¸¤ä¸ªå¯¹ç«‹å…³ç³» $<a,b>$ ï¼Œ$<a,c>$ ï¼Œä¸å¦¨å‡è®¾ $a$ ä¸º $a$ æ‰€åœ¨é›†åˆçš„ç¥–å®—/æ ¹èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°† $b$ å’Œ $c$ åŠ å…¥ $a$ é›†åˆçš„æ—¶å€™ï¼Œåœ¨ $bã€c$ ä¸ $a$ ä¹‹é—´å¼•å…¥ä¸€ä¸ªæƒå€¼ $1$ï¼Œåˆ™åœ¨è¯¢é—® $b$ ä¸ $c$ çš„å…³ç³»çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŸ¥è¯¢ä»–ä»¬åˆ°æ‰€åœ¨é›†åˆæ ¹èŠ‚ç‚¹çš„æƒå€¼ $1ã€1$ ï¼Œä¸¤ä¸ª $1$ ç›¸åŠ å¯¹ $2$ å–ä½™å¾—åˆ° $0$ï¼Œè¯´æ˜ $bã€c$ ä¸æ˜¯å¯¹ç«‹å…³ç³»ã€‚ 
å› è€Œå¸¦æƒå¹¶æŸ¥é›†çš„ $find$ ä¸ $unite$ å‡½æ•°éƒ½è¦é‡å†™ï¼Œå¼•å…¥ä¸€ä¸ªæƒå€¼æ•°ç»„ç»´æŠ¤**æŸä¸ªç‚¹åˆ°ç¥–å…ˆçš„æƒå€¼**ï¼Œåœ¨ $find$ çš„æ—¶å€™ $fa[s] = find(fa[s])$ æ—¶æ³¨æ„æƒå€¼çš„æ›´æ–°ï¼›åœ¨ $unite$ æ—¶ï¼Œåˆ™ä¸€å®šè¦**æŒ‰ç§©åˆå¹¶**ï¼Œæ›´æ–°è¾ƒè½»èŠ‚ç‚¹çš„ç¥–å®—èŠ‚ç‚¹ï¼Œå¹¶åŒæ—¶æ›´æ–°æƒå€¼ã€‚

**ä¾‹é¢˜**

1ã€[é£Ÿç‰©é“¾](https://www.luogu.com.cn/problem/P2024)
**é¢˜æ„**ï¼šåŒä¸Š
**é¢˜è§£**ï¼šè¿™é“é¢˜æœ‰ä¸¤ç§è§£æ³•ï¼Œè¿™é‡Œä»‹ç»å¸¦æƒå¹¶æŸ¥é›†çš„è§£æ³•:

~~~c++
//cjhçš„æ¿å­ å¥½ç”¨ï¼ğŸ¤“â˜ï¸
int n, m, ans, fa[N], ra[N], va[N];//va-è¯¥ç‚¹åˆ°ç¥–å…ˆè·ç¦»
void init() {
    for (int i = 1; i <= n; ++i) fa[i] = i;
}
int find(int a) {
    if (a == fa[a]) return a;
    int temp = find(fa[a]);
    va[a] = (va[a] + va[fa[a]]) % 3;
    fa[a] = temp;
    return fa[a];
}
void unite(int a, int b, int op) {
    int aa = find(a), bb = find(b);
    if (aa == bb) return;
    if (ra[aa] > ra[bb]) {
        fa[bb] = aa;
        va[bb] = (va[a] - va[b] - op + 3) % 3;
    }
    else {
        if (ra[aa] == ra[bb]) ra[bb]++;
        fa[aa] = bb;
        va[aa] = (va[b] - va[a] + op + 3) % 3;
    }
}
int query(int a, int b) {
    int aa = find(a), bb = find(b);
    if (aa != bb) return -1;
    else return (va[a] - va[b] + 3) % 3;
}
void solve() {
    cin >> n >> m;
    init();
    for (int i = 0; i < m; ++i) {
        int op, a, b;
        cin >> op >> a >> b;
        op--;
        if (a > n || b > n || op == 1 && a == b || query(a, b) != op && query(a, b) != -1) ans++;
        else unite(a, b, op);
    }
    cout << ans;
}
~~~

**2.[LCT](https://ac.nowcoder.com/acm/contest/81599/A)**
**å…³é”®è¯**ï¼šå¸¦æƒå¹¶æŸ¥é›†
**é¢˜æ„**ï¼šç»™å®šä¸€é¢—æœ‰æ ¹æ ‘ï¼Œæ¯æ¬¡è¯¢é—®å‰ $i$ æ¡è¾¹ç»„æˆçš„æ£®æ—ä¸­ï¼Œç¬¬ $c_i$ ä¸ªå¯åˆ°è¾¾çš„æœ€é•¿ç®€å•è·¯å¾„é•¿åº¦ï¼ˆ**ä¿è¯ $c_i$ ä¸ºæ ‘çš„æ ¹**ï¼‰ã€‚
**é¢˜è§£**ï¼šè¿™é“é¢˜è™½ç„¶åå­—å«LCTï¼Œä½†æ˜¯LCTä¼šè¢«å¡å†…å­˜ï¼ˆï¼Ÿï¼‰ã€‚è§‚å¯Ÿæ‰€ç»™æ¡ä»¶ï¼š $c_i$ æ˜¯æ ‘çš„æ ¹ï¼ŒåŸé—®é¢˜å¯ä»¥ç›´æ¥è½¬åŒ–ä¸ºæ±‚ä»¥ $c_i$ ä¸ºæ ¹çš„æ ‘çš„æ·±åº¦ï¼Œå®¹æ˜“æƒ³åˆ°ä½¿ç”¨å¸¦æƒå¹¶æŸ¥é›†æ¥ç»´æŠ¤æ¯ä¸ªé›†åˆ/æ ‘çš„æ·±åº¦ï¼Œåˆå¹¶æ—¶ä¿®æ”¹å³å¯ã€‚

---

## å¯æŒä¹…åŒ–å¹¶æŸ¥é›†

ç»™å®š $n$ ä¸ªé›†åˆï¼Œç¬¬ $i$ ä¸ªé›†åˆå†…åˆå§‹çŠ¶æ€ä¸‹åªæœ‰ä¸€ä¸ªæ•°ï¼Œä¸º $i$ã€‚

æœ‰ $m$ æ¬¡æ“ä½œã€‚æ“ä½œåˆ†ä¸º $3$ ç§ï¼š

 - `1 a b` åˆå¹¶ $a,b$ æ‰€åœ¨é›†åˆï¼›
 - `2 k` å›åˆ°ç¬¬ $k$ æ¬¡æ“ä½œï¼ˆæ‰§è¡Œä¸‰ç§æ“ä½œä¸­çš„ä»»æ„ä¸€ç§éƒ½è®°ä¸ºä¸€æ¬¡æ“ä½œï¼‰ä¹‹åçš„çŠ¶æ€ï¼›
 - `3 a b` è¯¢é—® $a,b$ æ˜¯å¦å±äºåŒä¸€é›†åˆï¼Œå¦‚æœæ˜¯åˆ™è¾“å‡º $1$ï¼Œå¦åˆ™è¾“å‡º $0$ã€‚

å¯æŒä¹…åŒ–å¹¶æŸ¥é›†å°±æ˜¯è§£å†³ä¸Šè¿°é—®é¢˜çš„ä¸€ç§ç‰¹åŒ–æ•°æ®ç»“æ„ã€‚æ³¨æ„åˆ°ï¼Œä¸Šè¿°çš„é—®é¢˜æ ¸å¿ƒåœ¨äº $fa[i]$ï¼Œè€ƒè™‘æ˜¯å¦æœ‰åˆé€‚çš„æ•°æ®ç»“æ„æ¥ç»´æŠ¤å®ƒï¼Œè”æƒ³åˆ°å¯æŒä¹…åŒ–çº¿æ®µæ ‘ç»´æŠ¤æ•°ç»„çš„æ¿å­ï¼Œæ•…è€ƒè™‘**ä¸»å¸­æ ‘**ã€‚æ¥ä¸‹æ¥è€ƒè™‘ä¼˜åŒ–ï¼Œå¹¶æŸ¥é›†å¸¸è§çš„ä¼˜åŒ–æ–¹å¼æœ‰ è·¯å¾„å‹ç¼©å’ŒæŒ‰ç§©åˆå¹¶ã€‚ç”±äºè·¯å¾„å‹ç¼©æ˜¯å‡æ‘Š $log(n)$ çš„æ—¶é—´å¤æ‚åº¦ï¼Œå•æ¬¡æŸ¥è¯¢çš„å¤æ‚åº¦æœ€é«˜å¯ä¸º $O(n)$ï¼Œå¦‚æœå¤šæ¬¡å›æº¯åˆ°è¯¥æƒ…å†µä¸‹ï¼Œæœ‰è¶…æ—¶å¯èƒ½ï¼›æ•…è€ƒè™‘**æŒ‰ç§©åˆå¹¶**ï¼Œæ—¶é—´å¤æ‚åº¦ä¸¥æ ¼ä¸º $O(log(n))$ã€‚å› è€Œå¾—å‡ºç»“è®ºï¼š**ä¸»å¸­æ ‘+æŒ‰ç§©åˆå¹¶**ï¼Œç”¨ä¸»å¸­æ ‘åŒæ—¶ç»´æŠ¤ $fa$ï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰ å’Œ $rank$ï¼ˆç§©å¤§å°ï¼‰ æ•°ç»„ã€‚

~~~c++
//std::ios::sync_with_stdio(false);
#include<bits/stdc++.h>
using namespace std;
const int MAXN = 1e5+10;
const int MAXM = 2e5+10;
typedef long long ll;
inline int read()
{
    int x = 0, f = 1; char ch = getchar();
    while (ch < '0' || ch>'9') { if (ch == '-') f = -1; ch = getchar(); }
    while (ch >= '0' && ch <= '9') { x = x * 10 + ch - 48; ch = getchar(); }
    return x * f;
}

//ç”¨ä¸»å¸­æ ‘ç»´æŠ¤faæ•°ç»„
#define ls(x) tree[x].ls
#define rs(x) tree[x].rs
#define fa(x) tree[x].fa
#define ra(x) tree[x].ra
struct node
{ 
	int ls,rs,fa,ra;
}tree[MAXN*320];
int A[MAXN],roots[MAXN],n,m,cnt=1,cur=0;
void build(int l=1,int r=n,int p=1)
{
    if(l==r) fa(p)=l,ra(p)=1;
    else{
        ls(p)=++cnt,rs(p)=++cnt;
        int mid=(l+r)/2;
        build(l,mid,ls(p));
        build(mid+1,r,rs(p));
    }
}
void update_fa(int x,int d,int p,int q,int cl=1,int cr=n) //å•ç‚¹ä¿®æ”¹
{
    tree[q]=tree[p];
    if(cl==cr) fa(q)=d;
    else{
        int mid=(cl+cr)/2;
        if(x<=mid){
            ls(q)=++cnt;
            update_fa(x,d,ls(p),ls(q),cl,mid);
        }
        else{
            rs(q)=++cnt;
            update_fa(x,d,rs(p),rs(q),mid+1,cr);
        }
    }
}
void update_ra(int x,int d,int p,int q,int cl=1,int cr=n) //å•ç‚¹ä¿®æ”¹
{
    tree[q]=tree[p];
    if(cl==cr) ra(q)=d;
    else{
        int mid=(cl+cr)/2;
        if(x<=mid){
            ls(q)=++cnt;
            update_ra(x,d,ls(p),ls(q),cl,mid);
        }
        else{
            rs(q)=++cnt;
            update_ra(x,d,rs(p),rs(q),mid+1,cr);
        }
    }
}
int query_fa(int x,int p,int cl=1,int cr=n)
{
    if(cl>x||cr<x) return 0;
    else if(cl>=x&&cr<=x) return fa(p);
    else{
        int mid=(cl+cr)/2;
        if(x<=mid) return query_fa(x,ls(p),cl,mid);
		else return query_fa(x,rs(p),mid+1,cr);
    }
}
int query_ra(int x,int p,int cl=1,int cr=n)
{
    if(cl>x||cr<x) return 0;
    else if(cl>=x&&cr<=x) return ra(p);
    else{
        int mid=(cl+cr)/2;
        if(x<=mid) return query_ra(x,ls(p),cl,mid);
		else return query_ra(x,rs(p),mid+1,cr);
    }
}

//å¹¶æŸ¥é›†
int find(int s) 
{
	int tfa=query_fa(s,roots[cur]);
	if(s==tfa) return s;
	else return find(tfa);	
}
void unite(int a, int b) 
{
    a = find(a), b = find(b);
    if (a == b) {
		roots[cur+1]=roots[cur];
	}
	int siz1=query_ra(a,roots[cur]),siz2=query_ra(b,roots[cur]);
    if (siz1>siz2) {
		roots[cur+1]=++cnt;
		update_fa(b,a,roots[cur],roots[cur+1]);
    } else {
		roots[cur+1]=++cnt;
        update_fa(a,b,roots[cur],roots[cur+1]);
        if (siz1 == siz2) {
			int temp=roots[cur+1];
			roots[cur+1]=++cnt;
			update_ra(b,siz2+1,temp,roots[cur+1]);
            //æ³¨æ„ï¼Œè¿™é‡Œçš„raéœ€è¦åœ¨å·²ç»æ›´æ–°è¿‡façš„æ ‘ä¸Šå»ºç«‹æ–°çš„æ ‘
		}
	}
}

void solve()
{
    n=read(),m=read();
    build();
    roots[0]=1;
    for(int i=1;i<=m;++i)
    {
		int op=read(),x=read();
		if(op==1){
			int y=read();
			unite(x,y);
		} else if(op==2){
			roots[cur+1]=roots[x];
		} else{
			int y=read();
			cout<<(find(x)==find(y)?"1\n":"0\n");
			roots[cur+1]=roots[cur];
		}
		cur++;
    }
}

int main()
{   
    int t=1; //cin>>t;
    while(t--)
    {
        solve();
    }
    return 0;
}
~~~



----

## å…¶ä»–

é“¾æ¥ï¼š[Problem - 1157E - Codeforces](https://codeforces.com/problemset/problem/1157/E)
**é¢˜ç›®å¤§æ„**ï¼šç»™å‡ºä¸¤ä¸ªé•¿åº¦ä¸º $n$ æ•°ç»„ $a$ $b$ ï¼Œ$b$ å¯éšæ„æ’åºï¼Œæ„é€ æ•°ç»„ $c = (a+b)%n$  æ±‚å­—å…¸åºæœ€å°çš„æ•°ç»„ $c$ã€‚
é¢˜ç›®è§£æ³•ï¼šä¸€çœ¼æƒ³æ³•æ˜¯å¯¹æ¯ä¸ª $a[i]$ ,æœ€ä½³çš„å€¼æ˜¯ $n-a[i]$ï¼Œå…¶æ¬¡æ˜¯æ¯” $n-a[i]$ å¤§çš„å€¼ï¼Œå†å…¶æ¬¡ä»æœ€å°çš„ $b[i]$ å¼€å§‹ã€‚å®ç°é€šè¿‡ç»´æŠ¤ $multiset$ ï¼Œç„¶åäºŒåˆ†æŸ¥æ‰¾ã€‚
ä½†æ˜¯è¿˜å¯ä»¥è¿™ä¹ˆåšï¼šç»´æŠ¤ä¸€ä¸ªæ•°ç»„ $num$ ï¼Œå­˜å‚¨ $b$ ä¸­å‡ºç°çš„æ•°å­—çš„ä¸ªæ•°ï¼Œå¯¹äºæ¯ä¸ª $a[i]$ ï¼ŒæŸ¥æ‰¾ $num[n-a[i]]$ ï¼Œä¸å­˜åœ¨åˆ™ä¸æ–­å‘åå–ï¼Œç»´æŠ¤æ–¹æ³•ä½¿ç”¨**å¹¶æŸ¥é›†**çš„æ€æƒ³ï¼Œç»´æŠ¤ä¸€ä¸ªæ•°ç»„ $nex$ å­˜å‚¨æ¯ä¸ªæ•°å­—æœ€åˆé€‚çš„ä¸‹ä¸€ä¸ªæ•°å­—ï¼Œç”¨ $find$ çš„æ€æƒ³ä¿®æ”¹ã€‚ 
ä»£ç è¯¦è§é“¾æ¥æäº¤ã€‚





# STè¡¨

~~~c++
#include <iostream>
#include <stdio.h>
using namespace std;
const int MAXN=1e6+100;

inline int read()  //å¿«è¯»
{
	int x=0,f=1;char ch=getchar();
	while (ch<'0'||ch>'9'){if (ch=='-') f=-1;ch=getchar();}
	while (ch>='0'&&ch<='9'){x=x*10+ch-48;ch=getchar();}
	return x*f;
}

int n, m, x, y;
int a[MAXN], lg[MAXN], f[MAXN][20];  //(1<<20) > 1e6+100
int main()
{
	n=read(),m=read();
	lg[1] = 0; 
    for(int i=2;i<=n;i++) lg[i]=lg[i>>1]+1;  //åˆå§‹åŒ–å¾—åˆ°log2çš„å€¼
	for (int i=1;i<=n;i++) {
        cin >> f[i][0];
    }
	for (int j = 1; j <= lg[n]; j++) {
		for (int i = 1; i <= n - (1 << j) + 1; i++) {
			f[i][j] = max(f[i][j - 1], f[i + (1 << (j - 1))][j - 1]);
		}
	}

	for (int i = 1; i <= m; i++) {
		x=read(),y=read();
		int l = lg[y - x + 1];
		cout << max(f[x][l], f[y - (1 << l) + 1][l]) << "\n";
	}
	return 0;
}
~~~

## äºŒç»´STè¡¨

[Cornfields - OpenJ_Bailian 2019 - Virtual Judge (vjudge.net)](https://vjudge.net/problem/OpenJ_Bailian-2019#author=GPT_zh)

~~~c++

~~~









# æ ‘çŠ¶æ•°ç»„

å®ç°**å•ç‚¹ä¿®æ”¹**å’Œ**åŒºé—´æ±‚å€¼**æ—¶ï¼Œç»¼åˆè€ƒè™‘ä¸¤ç§æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ï¼Œä½¿ç”¨æ ‘çŠ¶æ•°ç»„ï¼Œå¯ä½¿ä¸¤ç§éƒ½å˜ä¸ºOï¼ˆlognï¼‰çº§åˆ«ã€‚

![img](https://pic3.zhimg.com/80/v2-df001651925903a86ab640482b78c2d6_720w.webp)

å¦‚å›¾ï¼Œ**æ ‘çŠ¶æ•°ç»„**çš„åŸºæœ¬åŸç†åœ¨äºå»ºç«‹ä¸€ä¸ªæ•°ç»„æ¥ç®¡ç†åŸå…ˆæ•°ç»„ï¼Œè¯¥æ•°ç»„é€šè¿‡**äºŒè¿›åˆ¶**çš„ç›¸å…³åŸç†æ¥è¾¾åˆ°æŸ¥è¯¢ä¸ä¿®æ”¹æ—¶å€™çš„è·³è·ƒå¼æ“ä½œä»¥å‡å°‘æ—¶é—´å¤æ‚åº¦ã€‚

å‡è®¾å­˜åœ¨å¤§å°ä¸º $10$ çš„æ•°ç»„ $1 ,2 ,3 ,4 ,5 ,6 ,7 ,8 ,9 ,10$ã€‚å¦‚æœéœ€è¦å¯¹è¯¥æ•°ç»„è¿›è¡Œ**ä¿®æ”¹å€¼**ä»¥åŠ**åŒºé—´æ±‚å’Œ**çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘åˆ›å»ºæ•°ç»„ $tree[11]$ æ¥ç»´æŠ¤æŸå‡ ä¸ªç‰¹å®šåŒºé—´çš„å€¼ã€‚åœ¨**æ ‘çŠ¶æ•°ç»„**ä¸­ï¼Œä¸å‰ç¼€å’Œä¸åŒçš„æ˜¯ï¼Œtree[i] ç»´æŠ¤çš„æ˜¯ $[i-lowbit(i),i]$ çš„å’Œå€¼ï¼Œå…¶ä¸­ **lowbit(i) = (i &(-i))** ä»£è¡¨æ•°å­— i åœ¨äºŒè¿›åˆ¶çš„è¡¨ç¤ºå½¢å¼ä¸‹ç¬¬ä¸€æ¬¡å‡ºç°çš„ $1$ æ‰€ä»£è¡¨çš„å¤§å° ã€‚å› è€Œï¼Œå¦‚æœå°†æ•°ç»„treeä¸­çš„æ¯ä¸€ä¸ªä½ç½®æŒ‰ç…§å…¶ç»´æŠ¤çš„åŒºé—´å¤§å°ä¾æ¬¡ä¸Šä¸‹æ’åˆ—ï¼Œå°±ä¼šå½¢æˆå¦‚ä¸Šå›¾æ‰€ç¤ºçš„**æ ‘å½¢ç»“æ„**ï¼Œå› è€Œè¢«ç§°ä¸ºæ ‘çŠ¶æ•°ç»„ã€‚

æ ‘çŠ¶æ•°ç»„åœ¨ç»´æŠ¤åŒºé—´å’Œçš„å¤æ‚åº¦ä¸­çš„**å•ç‚¹ä¿®æ”¹**ä¸**åŒºé—´æ±‚å’Œ**ä¸¤ä¸ªæ“ä½œï¼Œå‡å¯ä»¥è¾¾åˆ° $O(logn)$ çº§åˆ«ã€‚

**å•ç‚¹ä¿®æ”¹**æ“ä½œï¼šå‡è®¾å¯¹ a[x] å¢åŠ  val å¤§å°çš„å€¼ï¼Œé‚£ä¹ˆæ‰¾åˆ° x æ‰€åœ¨ä½ç½®ï¼Œå¯¹tree[x] è¿›è¡Œä¸€ä¸ªvalçš„å¢åŠ ï¼Œåå› ä¸ºè¦†ç›–åŒºé—´ä¹‹é—´çš„å€æ•°å…³ç³»ï¼ˆå³è¦†ç›–ä½çº§åŒºé—´çš„æ¬¡é«˜çº§åŒºé—´çš„ç»´æŠ¤èŒƒå›´å¿…ç„¶æ˜¯å‰è€…ç»´æŠ¤èŒƒå›´çš„ä¸¤å€ï¼‰ï¼Œå¯¹ x è¿›è¡Œä¸€ä¸ªlowbit(x)çš„å¢åŠ ï¼Œå¹¶è¿›è¡Œç»´æŠ¤ã€‚ä¸æ–­è¿›è¡Œç›´è‡³xè¶…å‡ºæ•°ç»„èŒƒå›´ã€‚å› ä¸ºæ¯æ¬¡å‘ä¸‹ä¸€ä¸ªåŒºé—´è·³è·ƒçš„æ—¶å€™ï¼Œè·³è·ƒçš„å¤§å°ä¼šä¸æ–­å€å¢ï¼Œå› è€Œæ—¶é—´å¤æ‚åº¦æ˜¯ $O(logn)$ 

**åŒºé—´æ±‚å’Œ**æ“ä½œï¼šå‡è®¾è¦æ±‚æŸ¥è¯¢ $[l,r]$ èŒƒå›´å†…çš„å’Œå€¼ï¼Œä¾æ¬¡æ±‚å‡ºä½ç½® r ä¸ l - 1 çš„å‰ç¼€å’Œç„¶åç›¸å‡å³å¯ã€‚å¯¹äºå‰ç¼€å’Œçš„æ±‚æ³•ä¸å•ç‚¹ä¿®æ”¹ç±»ä¼¼ï¼Œä»¥ r ä¸ºä¾‹ï¼Œå…ˆè·å– tree[r] çš„å€¼ã€‚ç„¶åå†å°† r å‡å» lowbitï¼ˆrï¼‰å¾—åˆ°ä¸‹ä¸€ä¸ªç»´æŠ¤åŒºé—´çš„ç»´æŠ¤å…ƒç´ çš„ä½ç½®ï¼Œç„¶åå†æ¬¡è·å–ã€‚ä¸æ–­è¿›è¡Œç›´è‡³ r è¶…å‡ºæ•°ç»„èŒƒå›´ã€‚æ—¶é—´å¤æ‚åº¦ä¾ç„¶æ˜¯ $O(logn)$ ã€‚



**â‘  å•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æ±‚å€¼** 

~~~c++
#include <iostream>
using namespace std;
#define lowbit(x) x&(-x)

int n, m;
int a[500500], c[500500];

void add(int s,int val)  //æ›´æ–°æ ‘çŠ¶æ•°ç»„
{
	for (int i = s; i <= n; i += lowbit(i)) c[i] += val;   //è·³è·ƒç€å‰è¿›
	return;
}

int ask(int s)    //æ±‚å‰sé¡¹å’Œ
{
	int ans = 0;
	for (int i = s; i >= 1; i -= lowbit(i)) ans += c[i];   //è·³è·ƒç€åé€€æ±‚å’Œ
	return ans;
}

int main()
{
	ios::sync_with_stdio(false); cin.tie(0); cout.tie(0);
	cin >> n >> m;
	for (int i = 1; i <= n; i++) {
		cin >> a[i];
		add(i, a[i]);
	}
	for (int i = 1; i <= m; i++) {
		int opt, x, y;
		cin >> opt >> x >> y;
		if (opt == 1) add(x, y);	
		else if (opt == 2) cout << ask(y) - ask(x - 1) << "\n";
	}
	return 0;
}
~~~



**â‘¡ å•ç‚¹æ±‚å€¼ï¼ŒåŒºé—´ä¿®æ”¹** 

è¯¥æ–¹æ³•ç”¨**æ ‘çŠ¶æ•°ç»„**æ¥ç®¡ç†**å·®åˆ†æ•°ç»„**å³å¯å®ç°ã€‚

~~~c++
#include <iostream>
using namespace std;
const int MAXN = 500500;
#define lowbit(x) (x&(-x))

int n, m;
int tree[MAXN], a[MAXN];  //treeå­˜çš„æ˜¯å·®åˆ†æ•°ç»„çš„æ ‘çŠ¶æ•°ç»„
void add(int s, int val)
{
	for (int i = s; i <= n; i += lowbit(i))
		tree[i] += val;
	return;
}
int ask(int s)
{
	int ans = 0;
	for (int i = s; i >= 1; i -= lowbit(i))
		ans += tree[i];
	return ans;
}

int main()
{
	cin >> n >> m;
	for (int i = 1; i <= n; i++) cin >> a[i];
	for (int i = 1; i <= m; i++) {
		int opt, x, y, k;
		cin >> opt >> x;
		if (opt == 1) {
			cin >> y >> k;
			add(x, k); add(y + 1, -k);
		}
		else {
			cout << a[x] + ask(x) << "\n";
		}
	}
	return 0;
}
~~~

## é€†åºå¯¹

æ ‘çŠ¶æ•°ç»„è¿˜å¸¸è§åº”ç”¨äºæ±‚**é€†åºå¯¹**çš„é¢˜ç›®ä¸­ã€‚è½¬åŒ–ä¸ºæ±‚**éä¸¥æ ¼æ­£åºå¯¹**ï¼Œå†å˜æ¢å¾—åˆ°é€†åºå¯¹æ•°ç›®ã€‚å…¶ä¸­ï¼Œæ ‘çŠ¶æ•°ç»„ç»´æŠ¤çš„æ˜¯æ¯ä¸€ä¸ªå€¼çš„ä¸ªæ•°ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ±‚5 4 1 3 2çš„é€†åºå¯¹ã€‚ç”¨ansè®°å½•éä¸¥æ ¼é¡ºåºå¯¹çš„æ•°é‡ã€‚

![img](https://pic2.zhimg.com/80/v2-ec0a0dd0968f9e599d1e312e2dee2695_720w.webp)

æˆ‘ä»¬æŒ‰é¡ºåºå»å¡«å……æ ‘çŠ¶æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªæ•°å­—æ˜¯5ï¼Œè¿™æ—¶æ²¡æœ‰æ•°æ¯”5å°ï¼Œæ‰€ä»¥ansä¿æŒä¸º0ã€‚æˆ‘ä»¬æŠŠtree[5]å¡«ä¸º1ã€‚

![img](https://pic2.zhimg.com/80/v2-b67518fb5b4944aa3832c8f98c951541_720w.webp)

ä¸‹ä¸€ä¸ªæ•°å­—æ˜¯1ï¼Œè¿™æ—¶ä¹Ÿæ²¡æœ‰æ•°æ¯”1å°ï¼Œansä»ä¸º0ã€‚æˆ‘ä»¬æŠŠtree[1]å¡«ä¸º1ã€‚

![img](https://pic3.zhimg.com/80/v2-89037dfcae45ef605aca756eea070bae_720w.webp)

ä¸‹ä¸€ä¸ªæ•°å­—æ˜¯3ï¼Œè¿™æ—¶query(3)ä¸º1ï¼Œæœ‰ä¸€ä¸ªæ•°æ¯”3å°äº†ï¼Œanså˜ä¸º1ã€‚ç„¶åå†å¡«tree[3]ã€‚

![img](https://pic2.zhimg.com/80/v2-b2377fea1a6820a6c59e10ef74978bbd_720w.webp)

ä¸‹ä¸€ä¸ªæ•°å­—æ˜¯2ï¼Œè¿™æ—¶query(2)ä¸º1ï¼Œè¯´æ˜å‰é¢æœ‰ä¸€ä¸ªæ•°æ¯”2å°ï¼Œanså†åŠ 1å˜ä¸º2ã€‚ç„¶åå¡«tree[2]ã€‚

![img](https://pic3.zhimg.com/80/v2-0bac0074d0f14aef0711080fb12d7132_720w.webp)

æœ€åä¸€ä¸ªæ•°å­—æ˜¯4ï¼Œquery(4)ä¸º3ï¼Œè¯´æ˜å‰é¢æœ‰3ä¸ªæ•°æ¯”4å°ï¼ŒansåŠ 3å˜ä¸º5ã€‚æ‰€ä»¥éä¸¥æ ¼é¡ºåºå¯¹çš„æ€»æ•°å°±æ˜¯5ã€‚é‚£ä¹ˆé€†åºå¯¹å…±æœ‰ C52âˆ’5=5 ä¸ªã€‚

![img](https://pic1.zhimg.com/80/v2-d66c4d6d8a07772e05484047a7c1455c_720w.webp)



[å°é±¼æ¯”å¯çˆ±](https://www.luogu.com.cn/problem/P1428)è¿™é“é¢˜å¯ä»¥æš´åŠ›åšï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ ‘çŠ¶æ•°ç»„ã€‚
å…¶å®**é€†åºå¯¹**é—®é¢˜çš„åŸç†ï¼Œæ˜¯**äºŒç»´ååº**çš„åº”ç”¨ï¼ŒäºŒä½ååºçš„å†…å®¹åœ¨è¿™é‡Œä¸è¯¦è§£ã€‚

## æ±‚å¤šå…ƒç»„

**ä¾‹é¢˜**

**([CF61E ](https://codeforces.com/problemset/problem/61/E))** **Enemy is weak**
**å…³é”®è¯**ï¼šæ±‚ä¸‰å…ƒç»„æ•°ç›®
**é¢˜ç›®å¤§æ„**ï¼šæ±‚æ•°ç»„ä¸­ $i<j<k$ ä½† $a_i>a_j>a_k$ çš„æ•°ç›®ã€‚
**é¢˜è§£**ï¼šå…ˆé€šè¿‡æ±‚**é€†åºå¯¹**çš„æ–¹æ³•ç»´æŠ¤ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„ï¼Œåœ¨æ±‚é€†åºå¯¹çš„åŒæ—¶ï¼Œå†ç”¨ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„ç»´æŠ¤æ¯ä¸ªå…ƒç´  $j$ ç¬¦åˆ $i<jä¸”a_i>a_j$ ï¼Œä¹Ÿå°±æ˜¯é€†åºå¯¹çš„æ•°ç›®ï¼ˆå°†æ±‚é€†åºå¯¹ä¸­åŠ çš„1è½¬æ¢ä¸ºåŠ é€†åºå¯¹æ•°ç›®ï¼‰ã€‚è¿™æ ·è®²æœ‰ç‚¹æŠ½è±¡ï¼Œä¸Šä»£ç ï¼

~~~c++
    //numç”¨æ¥æ±‚é€†åºå¯¹ vç”¨æ¥ä¸‰å…ƒé€†åºå¯¹
	for(int i=1;i<=n;++i)
    {
        ll temp=ask(n,num)-ask(b[i],num);  
        ans += ask(n,v) - ask(b[i],v); 

        add(b[i],temp,v);
        add(b[i],1,num);  
    }
	//ç®€å•æ¥è¯´ è¿™é‡Œçš„numæ•°ç»„æ±‚é€†åºå¯¹çš„æ–¹æ³•æ˜¯å°† a[i]æ”¾åˆ°æ ‘çŠ¶æ•°ç»„çš„æŒ‡å®šä½ç½® update(a[i],1)
	//åŒæ—¶æ¯ä¸€ä¸ªå…ƒç´ æ”¾å…¥æœ‰å¤šå°‘ä¸ªæ¯”ä»–å¤§çš„å€¼å·²ç»æ”¾å…¥ ä¹Ÿå°±æ˜¯ask(a[n])-ask(a[i])æœ‰å¤šå°‘ä¸ªå€¼
	//è¿™é‡Œç”¨ä¸€æ ·çš„æ€æƒ³æ±‚ä¸‰ç»´é€†åºå¯¹ å°†a[i]å·²ç»æœ‰çš„é€†åºå¯¹çš„æ•°ç›®æ”¾å…¥æŒ‡å®šä½ç½® update(a[i],num);
	//åŒæ—¶åˆ¤æ–­æ­¤æ—¶æœ‰å‡ ä¸ªé€†åºå¯¹ç»„å·²ç»æ”¾å…¥ å°†ä»–ä»¬éƒ½åŠ è¿›æ¥ ä¹Ÿå°±æ˜¯ask(a[n])-aks(a[i])
~~~



**([CF597C ](https://codeforces.com/problemset/problem/597/C))** **Subsequences**
**å…³é”®è¯**ï¼šæ±‚å¤šå…ƒæ•°ç»„
**é¢˜ç›®å¤§æ„**ï¼šæ±‚é•¿åº¦ä¸º $k(1<=k<=10)$ çš„é€’å¢å­æ•°ç»„çš„æ•°ç›®

~~~c++
    //è¿™é‡Œçš„æ€è·¯ä¸ä¸Šé¢åŸºæœ¬ä¸€è‡´
	for(int i=1;i<=n;++i)
    {
        temp=1;
        for(int j=0;j<k;++j)
        {
            add(b[i],temp,j);
            temp=ask(b[i]-1,j);
            if(j==k-1)
            {
                ans+=temp;
            }
        }
    }
~~~



## ååºé—®é¢˜



## +ç¦»çº¿

**ä¾‹é¢˜**

[P1972 [SDOI2009\] HHçš„é¡¹é“¾ - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P1972)
**å…³é”®è¯**ï¼šç¦»æ•£åŒ–+æ ‘çŠ¶æ•°ç»„ï¼ˆç»å…¸æ¿å­é¢˜ï¼‰ã€‚
**é¢˜ç›®å¤§æ„**ï¼šç»™å‡ºä¸€ä¸²é•¿åº¦ä¸º $n$ çš„æ•°ç»„ï¼Œç»™å‡º $m$ ä¸ªè¯¢é—® ï¼š$[l,r]$ èŒƒå›´å†…æœ‰å‡ ä¸ªä¸åŒçš„æ•°å­—ã€‚
**é¢˜è§£**ï¼šå¯¹äºè‹¥å¹²ä¸ªè¯¢é—®çš„åŒºé—´ $[l,r]$ ï¼Œå¦‚æœ**ä»–ä»¬çš„ $r$ éƒ½ç›¸ç­‰**çš„è¯ï¼Œé‚£ä¹ˆé¡¹é“¾ä¸­å‡ºç°çš„åŒä¸€ä¸ªæ•°å­—ï¼Œä¸€å®šæ˜¯**åªå…³å¿ƒå‡ºç°åœ¨æœ€å³è¾¹çš„é‚£ä¸€ä¸ªçš„**ã€‚å› è€Œå¯ä»¥å°†å­˜å‚¨æ‰€æœ‰è¯¢é—®ï¼ŒæŒ‰ç…§ $r$ æ’åˆ—è¯¢é—®ï¼Œç„¶åéå†ç»´æŠ¤çç ç±»å‹çš„æ•°ç»„ï¼Œæ¯å‘ä¸‹éå†ä¸€ä¸ª $i$ ï¼Œå›ç­”æ‰€æœ‰ $r = i$ çš„è¯¢é—®ã€‚è€Œå¿«é€Ÿå›ç­”è¯¢é—®å¯ä»¥ç”¨**æ ‘çŠ¶æ•°ç»„**ç»´æŠ¤ï¼Œæ¯éå†åˆ°ä¸€ä¸ªæ–°çš„ $i$ ï¼Œ$add(i,1)$ï¼ŒåŒæ—¶å°†åœ¨å®ƒä¹‹å‰çš„ $last[i]$ è¿›è¡Œ $add(last[i],-1)$ï¼Œç„¶åä½¿ç”¨ $ask(r) - ask(l)$ å°±å¯ä»¥å¿«é€Ÿå¾—åˆ°åŒºé—´å†…ä¸åŒçš„ç±»å‹ã€‚
**ä»£ç **ï¼š

~~~c+++
...
int n,c[MAXN];
void add(int s,int val)  //æ›´æ–°æ ‘çŠ¶æ•°ç»„
{
	for (int i = s; i <= n; i += lowbit(i)) c[i] += val;   //è·³è·ƒç€å‰è¿›
	return;
}
int ask(int s)    //æ±‚å‰sé¡¹å’Œ
{
	int ans = 0;
	for (int i = s; i >= 1; i -= lowbit(i)) ans += c[i];   //è·³è·ƒç€åé€€æ±‚å’Œ
	return ans;
}

struct node
{
    int l, r,ans,id;
}q[MAXN];
int m,last[MAXN],a[MAXN],ans[MAXN];
bool cmp(node x,node y)
{
    return x.r<y.r;
}

void solve()
{
    n=read();
    for(int i=1;i<=n;++i)
    {
        a[i]=read();
    }
    m=read();
    for(int i=1;i<=m;++i)
    {
        q[i].l=read(),q[i].r=read();
        q[i].id=i;
    }
    sort(q+1,q+m+1,cmp);

    for(int i=1, j=1;i<=n;++i)
    {
        if(last[a[i]]!=0)
        {
            add(last[a[i]],-1);
        }
        add(i,1);
        last[a[i]]=i;
        
        //debug(i<<" "<<ask(i));
        while(q[j].r<=i&&j<=m)
        {
            q[j].ans=ask(q[j].r)-ask(q[j].l-1);
            j++;
        }
    }

    for(int i=1;i<=m;++i)
    {
        ans[q[i].id]=q[i].ans;
    }
    for(int i=1;i<=m;++i)
    {
        cout<<ans[i]<<'\n';
    }
    return;
}
...
~~~



[F - Range Set Query (atcoder.jp)](https://atcoder.jp/contests/abc174/tasks/abc174_f?lang=en)
é‡ä¸Šé¢é‚£é“é¢˜åŸºæœ¬ä¸€æ ·ã€‚

## +ç¦»æ•£åŒ–

æ ‘çŠ¶æ•°ç»„æœ‰æ—¶å€™è¦ç»´æŠ¤æ•°ç»„çš„**å€¼**ï¼Œå¦‚æœå€¼èŒƒå›´å¾ˆå¤§å¯èƒ½æ— æ³•å­˜å‚¨è¿›æ•°ç»„ã€‚æ­¤æ—¶å¦‚æœå€¼å¾ˆåˆ†æ•£ï¼Œå¯ä»¥**ç¦»æ•£åŒ–**ï¼Œå°†å€¼ç¼©åˆ°è¾ƒå°çš„èŒƒå›´å†…ï¼Œä½¿å¾—æ ‘çŠ¶æ•°ç»„å¯ä»¥ç»´æŠ¤ä»–ä»¬ã€‚

**ä¾‹é¢˜**

[Problem - 540E - Codeforces](https://codeforces.com/problemset/problem/540/E)
**é¢˜ç›®å¤§æ„ï¼š** æœ‰ä¸€ä¸ªæ— é™åºåˆ—ï¼Œæ‰€æœ‰æ­£æ•´æ•°æŒ‰é€’å¢é¡ºåºæ’åˆ—ï¼š pâ€‰=â€‰{1,â€‰2,â€‰3,â€‰...} ã€‚æˆ‘ä»¬å¯¹æ­¤åºåˆ—æ‰§è¡Œäº† n ä¸ª äº¤æ¢ æ“ä½œã€‚ swap(a,â€‰b) æ˜¯äº¤æ¢åºåˆ—ä¸­ä½ç½® a å’Œ b ä¸Šçš„å…ƒç´ çš„æ“ä½œã€‚æ‚¨çš„ä»»åŠ¡æ˜¯æ‰¾å‡ºç»“æœåºåˆ—ä¸­çš„åè½¬æ¬¡æ•°ï¼Œå³ iâ€‰<â€‰j å’Œ piâ€‰>â€‰pj è¿™æ ·çš„ç´¢å¼•å¯¹ (i,â€‰j) çš„æ•°é‡ã€‚
**é¢˜è§£ï¼š** å‡å¦‚æ•°ç»„çš„å¤§å°èŒƒå›´å¾ˆå°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨**æ ‘çŠ¶æ•°ç»„æ±‚é€†åºå¯¹**å¾—åˆ°ç»“æœï¼Œä½†æ˜¯æ•°ç»„æœ€å¤§å€¼å¯è¾¾ $1e9$ï¼Œä½†äº¤æ¢çš„æ•°å¯¹æ•°ç›®åªæœ‰ $1e5$ï¼Œè€ƒè™‘ä½¿ç”¨**ç¦»æ•£åŒ–**ï¼šéœ€è¦ $swap$ çš„æ•°å­—å•ç‹¬ä½œä¸€ç»„ï¼Œè®¡ç®—é€†åºå¯¹æ—¶çš„è´¡çŒ®ä¸º1ï¼›å¤¹åœ¨ä¸¤ä¸ªéœ€è¦$swap$ ä¹‹é—´çš„æ•°å­—é›†åˆä½œä¸ºä¸€ç»„ï¼Œè´¡çŒ®å³æ•°å­—ä¸ªæ•°ã€‚è¿™æ ·å¯ä»¥ä¿è¯æ ‘çŠ¶æ•°ç»„éœ€è¦ç»´æŠ¤çš„å€¼æœ€å¤§ä¸è¶…è¿‡ $4e5$ã€‚
**ä»£ç **ï¼š

~~~C++
...

ll n,c[MAXN];
void add(ll s,ll val)  //æ›´æ–°æ ‘çŠ¶æ•°ç»„
{
	for (int i = s; i <= n; i += lowbit(i)) c[i] += val;   //è·³è·ƒç€å‰è¿›
	return;
}
ll ask(ll s)    //æ±‚å‰sé¡¹å’Œ
{
	ll ans = 0;
	for (int i = s; i >= 1; i -= lowbit(i)) ans += c[i];   //è·³è·ƒç€åé€€æ±‚å’Œ
	return ans;
}

struct node
{
    ll id, v;
}a[MAXN],d[MAXN];
ll m,b[MAXN];

bool cmp(node x,node y)
{
    return x.v<y.v;
}

void solve()
{
    cin>>n;
    for(int i=1;i<=n;++i)
    {
        cin>>a[i*2-1].v>>a[i*2].v;
        a[i*2-1].id=a[i*2].id=i;
        m=max(m,max(a[i*2-1].v,a[i*2].v));
    }
    sort(a+1,a+2*n+1,cmp);

    int cnt=0;
    for(int i=1;i<=2*n;++i) //è¿›è¡Œç¦»æ•£åŒ–
    {
        if(a[i].v>a[i-1].v)
        {
            ++cnt;
            if(a[i].v-1>a[i-1].v)
            {
                d[cnt++].v = a[i].v-a[i-1].v-1;
            }
        }
        if(b[a[i].id*2-1]!=0)
        {
            b[a[i].id*2]=cnt;
        }
        else
        {
            b[a[i].id*2-1]=cnt;
        }
        d[cnt].v=1;
    }
    for(int i=1;i<=cnt;++i)
    {
        d[i].id=i;
    }
    for(int i=1;i<=n;++i)
    {
        swap(d[b[i*2-1]],d[b[i*2]]);
    }

    ll sum=0; n=cnt;
	for (int i = 1; i <= cnt; i++) { //æ±‚é€†åºå¯¹æ•°ç›®
		add(d[i].id, d[i].v);
        sum+=ask(d[i].id-1)*d[i].v;
        sum+=d[i].v*(d[i].v-1)/2;
	}
    sum=m*(m-1)/2-sum;
    cout<<sum;

    return;
}

int main()
{
    int t=1;

    while(t--)
    {
        solve();
    }
}
~~~



##  äºŒç»´æ ‘çŠ¶æ•°ç»„

è¿™å®Œå…¨å°±æ˜¯æˆ‘çš„çŸ¥è¯†ç›²åŒºï¼Œæœ‰æ—¶é—´å¯ä»¥è¡¥ä¸€è¡¥ï¼ˆè™½ç„¶ç°åœ¨ä¼°è®¡éƒ½æ²¡æœ‰æ—¶é—´å°±æ˜¯äº†ï¼‰ã€‚

**ä¾‹é¢˜**

[Matrix - OpenJ_Bailian 2155 - Virtual Judge (vjudge.net)](https://vjudge.net/problem/OpenJ_Bailian-2155)

## æ€ç»´é¢˜

ä¸€èˆ¬æ ‘çŠ¶æ•°ç»„ï¼Œæ€»é‡è¦çš„é—®é¢˜æ˜¯æ‰¾åˆ°å……å½“ **æ ‘çŠ¶æ•°ç»„çš„é”®** å’Œ **æ ‘çŠ¶æ•°ç»„çš„å€¼** çš„ä¸¤ä¸ªå€¼ï¼Œç„¶åé€šè¿‡æ ‘çŠ¶æ•°ç»„çš„æ€§è´¨æ¥è§£å†³é—®é¢˜ã€‚

**ä¾‹é¢˜**ï¼š

[P5094 [USACO04OPEN\] MooFest G åŠ å¼ºç‰ˆ - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P5094)
**å…³é”®è¯ï¼š**æ ‘çŠ¶æ•°ç»„+æ€ç»´
**é¢˜ç›®å¤§æ„**ï¼šç»™å®šä¸¤ä¸ªé•¿åº¦ä¸º $n$ çš„åºåˆ— $v,x$ ï¼Œå®šä¹‰ä¸€ä¸ªç‚¹å¯¹ $(i,j)(i \neq j) $ çš„ä»·å€¼ $f(i,j) = max(v1,v2)*|x1-x2|$,æ±‚ï¼š
$$
\sum_{i=1}^{n}\sum_{j=1}^{n}f(i,j)[i\neq j]
$$
**é¢˜è§£ï¼š**è€ƒè™‘ä½¿ç”¨æ ‘çŠ¶æ•°ç»„ï¼ˆä¸ºä»€ä¹ˆç”¨æ ‘çŠ¶æ•°ç»„ï¼Ÿå› ä¸ºæ˜¯æ ‘çŠ¶æ•°ç»„ä¸“é¢˜é‡Œçš„ï¼‰ã€‚ç”±äºç‚¹å¯¹çš„ä»·å€¼ä¸ $max(v1,v2)$ æœ‰å…³ï¼Œè€Œ $max$ ä¸å¥½ç»´æŠ¤ï¼Œæˆ‘ä»¬è€ƒè™‘è®©åºåˆ—**æ ¹æ® $v$ çš„å¤§å°è¿›è¡Œæ’åº**ï¼Œè¿™æ ·å°±åªéœ€è¦è€ƒè™‘**é å**çš„ $v$ ,è¿™ä¸æ ‘çŠ¶æ•°ç»„**æ±‚é€†åºå¯¹çš„æ€æƒ³**ç±»ä¼¼ã€‚å› æ­¤ï¼Œéå†æ’åºå¥½åçš„æ ‘çŠ¶æ•°ç»„ï¼Œä½¿ç”¨æ ‘çŠ¶æ•°ç»„åŒæ—¶ç»´æŠ¤ **æ•°ç›®** å’Œ $x$ å³å¯ï¼š

~~~c++
        ans+=cow[i].v*(cow[i].x*ask(cow[i].x,num)-ask(cow[i].x,d)); 
        ans+=cow[i].v*((ask(m,d)-ask(cow[i].x,d))-(ask(m,num)-ask(cow[i].x,num))*cow[i].x);
        add(cow[i].x,1,num); //ç»´æŠ¤æ•°ç›®
        add(cow[i].x,cow[i].x,d); //ç»´æŠ¤x
~~~

---

[Problem - 652D - Codeforces](https://codeforces.com/problemset/problem/652/D)
**å…³é”®è¯ï¼š**æ ‘çŠ¶æ•°ç»„+æ€ç»´
**é¢˜è§£**ï¼šæŒ‰ç…§å·¦ç«¯ä½ç½®æ’åºï¼Œæ±‚æ­£åºå¯¹æ•°ç›®ã€‚



# çº¿æ®µæ ‘

## çº¿æ®µæ ‘

<a id="Segment Tree">**çº¿æ®µæ ‘**</a>ï¼ˆSegment Treeï¼‰å‡ ä¹æ˜¯ç®—æ³•ç«èµ›æœ€å¸¸ç”¨çš„æ•°æ®ç»“æ„äº†ï¼Œå®ƒä¸»è¦ç”¨äºç»´æŠ¤**åŒºé—´ä¿¡æ¯**ï¼ˆè¦æ±‚æ»¡è¶³ç»“åˆå¾‹ï¼‰ã€‚ä¸æ ‘çŠ¶æ•°ç»„ç›¸æ¯”ï¼Œå®ƒå¯ä»¥å®ç° O(logâ¡ n) çš„**åŒºé—´ä¿®æ”¹**ï¼Œè¿˜å¯ä»¥åŒæ—¶æ”¯æŒ**å¤šç§æ“ä½œ**ï¼ˆåŠ ã€ä¹˜ï¼‰ï¼Œæ›´å…·é€šç”¨æ€§ã€‚

**çº¿æ®µæ ‘çš„å»ºç«‹ï¼š**

çº¿æ®µæ ‘æ˜¯ä¸€æ£µ**å¹³è¡¡äºŒå‰æ ‘**ã€‚æ¯ç»“ç‚¹ä»£è¡¨æ•´ä¸ªåŒºé—´çš„å’Œï¼Œè¶Šå¾€ä¸‹åŒºé—´è¶Šå°ã€‚æ³¨æ„ï¼Œçº¿æ®µæ ‘çš„æ¯ä¸ª**èŠ‚ç‚¹**éƒ½å¯¹åº”ä¸€æ¡**çº¿æ®µï¼ˆåŒºé—´ï¼‰**ï¼Œä½†å¹¶ä¸ä¿è¯æ‰€æœ‰çš„çº¿æ®µï¼ˆåŒºé—´ï¼‰éƒ½æ˜¯çº¿æ®µæ ‘çš„èŠ‚ç‚¹ï¼Œè¿™ä¸¤è€…åº”å½“åŒºåˆ†å¼€ã€‚

ä¸‹å›¾ä¸ºçº¿æ®µæ ‘å»ºç«‹çš„è¿‡ç¨‹

![åŠ¨å›¾](https://pic4.zhimg.com/v2-c2d11b12c87b6a7076e3df0bb3585423_b.webp)

å¯¹åº”çš„ä»£ç å®ç°ï¼š

~~~c++
void build(ll l = 1, ll r = n, ll p = 1)
{
    if (l == r) // åˆ°è¾¾å¶å­èŠ‚ç‚¹
        tree[p] = A[l]; // ç”¨æ•°ç»„ä¸­çš„æ•°æ®èµ‹å€¼
    else
    {
        ll mid = (l + r) / 2;
        build(l, mid, p * 2); // å…ˆå»ºç«‹å·¦å³å­èŠ‚ç‚¹
        build(mid + 1, r, p * 2 + 1);
        tree[p] = tree[p * 2] + tree[p * 2 + 1]; // è¯¥èŠ‚ç‚¹çš„å€¼ç­‰äºå·¦å³å­èŠ‚ç‚¹ä¹‹å’Œ
    }
}
~~~

**åŒºé—´ä¿®æ”¹**

ç±»ä¼¼äºåˆ†å—çš„æ€æƒ³ï¼Œè¿™é‡Œå¼•å…¥**æ‡’æ ‡è®°**ä»¥å–ä»£æœ´ç´ çš„é€’å½’ï¼Œä»¥å¢åŠ æ—¶é—´æ•ˆç‡ã€‚

*ä»¤l,rä¸ºæ‰€é€‰ä¿®æ”¹çš„åŒºé—´ï¼Œclï¼Œcrä¸ºé€’å½’çš„å½“å‰åŒºé—´*

- å½“r<clæˆ–è€…l>crçš„æ—¶å€™ï¼Œèˆå»ï¼ˆå‰ªæï¼‰ï¼š

  ![img](https://pic1.zhimg.com/80/v2-794f7124f288eeae7661200d948f43a4_720w.webp)

- å½“cl>=lå¹¶ä¸”cr<=rçš„æ—¶å€™ï¼Œè¯´æ˜å½“å‰åŒºé—´è¢«æ‰€é€‰åŒºé—´åŒ…å«ï¼Œå¯ç›´æ¥æ›´æ–°è¯¥åŒºé—´ã€‚

  ![img](https://pic3.zhimg.com/80/v2-abebb05b5e4c44821e7325c6e6b623fe_720w.webp)

- å…¶ä»–æƒ…å†µï¼Œè¯´æ˜æ‰€é€‰åŒºé—´ä¸å®Œå…¨åŒ…å«å½“å‰åŒºé—´ã€‚é‚£ä¹ˆå¯¹å½“å‰åŒºé—´åˆ†åˆ«å¤„ç†ï¼Œè€Œåœ¨å¤„ç†å‰éœ€è¦å°†æ‡’æ ‡è®°ä¸‹ç§»

  ![img](https://pic3.zhimg.com/80/v2-10c7ce5904b8300109f51e290ff2c14a_720w.webp)

~~~c++
void update(ll l, ll r, ll d, ll p = 1, ll cl = 1, ll cr = n)
{
    if (cl > r || cr < l) // åŒºé—´æ— äº¤é›†
        return; // å‰ªæ
    else if (cl >= l && cr <= r) // å½“å‰èŠ‚ç‚¹å¯¹åº”çš„åŒºé—´åŒ…å«åœ¨ç›®æ ‡åŒºé—´ä¸­
    {
        tree[p] += (cr - cl + 1) * d; // æ›´æ–°å½“å‰åŒºé—´çš„å€¼
        if (cr > cl) // å¦‚æœä¸æ˜¯å¶å­èŠ‚ç‚¹
            mark[p] += d; // ç»™å½“å‰åŒºé—´æ‰“ä¸Šæ ‡è®°
    }
    else // ä¸ç›®æ ‡åŒºé—´æœ‰äº¤é›†ï¼Œä½†ä¸åŒ…å«äºå…¶ä¸­
    {
        ll mid = (cl + cr) / 2;
        mark[p * 2] += mark[p]; // æ ‡è®°å‘ä¸‹ä¼ é€’
        mark[p * 2 + 1] += mark[p];
        tree[p * 2] += mark[p] * (mid - cl + 1); // å¾€ä¸‹æ›´æ–°ä¸€å±‚
        tree[p * 2 + 1] += mark[p] * (cr - mid);
        mark[p] = 0; // æ¸…é™¤æ ‡è®°
        update(l, r, d, p * 2, cl, mid); // é€’å½’åœ°å¾€ä¸‹å¯»æ‰¾
        update(l, r, d, p * 2 + 1, mid + 1, cr);
        tree[p] = tree[p * 2] + tree[p * 2 + 1]; // æ ¹æ®å­èŠ‚ç‚¹æ›´æ–°å½“å‰èŠ‚ç‚¹çš„å€¼
    }
}
~~~

å¯ä»¥å°†æ‡’æ ‡è®°å‘ä¸‹ä¼ é€’çš„è¿‡ç¨‹ç”¨å‡½æ•°å•ç‹¬è¡¨ç¤ºã€‚

~~~c++
inline void push_down(ll p, ll len)
{
    mark[p * 2] += mark[p];
    mark[p * 2 + 1] += mark[p];
    tree[p * 2] += mark[p] * (len - len / 2);
    tree[p * 2 + 1] += mark[p] * (len / 2); // å³è¾¹çš„åŒºé—´å¯èƒ½è¦çŸ­ä¸€ç‚¹
    mark[p] = 0;
}
~~~

**åŒºé—´æ±‚å’Œ**

åŒºé—´æ±‚å’Œçš„æ–¹æ³•ä¸åŒºé—´æ›´æ–°ç±»ä¼¼ã€‚

~~~c++
ll query(ll l, ll r, ll p = 1, ll cl = 1, ll cr = n)
{
    if (cl > r || cr < l)
        return 0;
    else if (cl >= l && cr <= r)
        return tree[p];
    else
    {
        ll mid = (cl + cr) / 2;
        push_down(p, cr - cl + 1);
        return query(l, r, p * 2, cl, mid) + query(l, r, p * 2 + 1, mid + 1, cr); 
        // ä¸Šä¸€è¡Œæ‹†æˆä¸‰è¡Œå†™å°±å’ŒåŒºé—´ä¿®æ”¹æ ¼å¼ä¸€è‡´äº†
    }
}
~~~

å®Œæ•´çš„ä»£ç å®ç°

~~~c++
#include <iostream>
using namespace std;
typedef long long ll;
const int MAXN = 100010;

ll n, m;
ll a[MAXN];
ll tree[MAXN * 4], lazy[MAXN * 4];

void build(ll p = 1, ll l = 1, ll r = n)
{
	if (l == r) tree[p] = a[l];
	else {
		ll mid = (l + r) / 2;
		build(p * 2, l, mid);
		build(p * 2 + 1, mid + 1, r);
		tree[p] = tree[p * 2] + tree[p * 2 + 1];
	}
	return;
}

inline void push_down(ll p, ll len)
{
	lazy[p * 2] += lazy[p];
	lazy[p * 2 + 1] += lazy[p];
	tree[p * 2] += (len - len / 2) * lazy[p];
	tree[p * 2 + 1] += lazy[p] * (len / 2);
	lazy[p] = 0;
	return;
}

void update(ll cl, ll cr, ll d, ll p = 1, ll l = 1, ll r = n)
{
	if (l > cr || r < cl) return;
	else if (l >= cl && r <= cr) {
		tree[p] += d * (r - l + 1);
		if (l < r) lazy[p] += d;
	}
	else {
		ll mid = (l + r) / 2;
		push_down(p, r - l + 1);
		update(cl, cr, d, p * 2, l, mid);
		update(cl, cr, d, p * 2 + 1, mid + 1, r);
		tree[p] = tree[p * 2] + tree[p * 2 + 1];
	}
	return;
}

ll ask(ll cl, ll cr, ll p = 1, ll l = 1, ll r = n)
{
	if (l > cr || r < cl) return 0;
	else if (l >= cl && r <= cr) return tree[p];
	else {
		ll mid = (l + r) / 2;
		push_down(p, r - l + 1);
		return ask(cl, cr, p * 2, l, mid) + ask(cl, cr, p * 2 + 1, mid + 1, r);
	}
}

int main()
{
	cin >> n >> m;
	for (int i = 1; i <= n; i++) cin >> a[i];
	build();
	while (m--) {
		ll o, x, y, k;
		cin >> o >> x >> y;
		if (o == 1) {
			cin >> k;
			update(x, y, k);
		}
		else if (o == 2)
			cout << ask(x, y) << "\n";
	}
	return 0;
}
~~~

**çº¿æ®µæ ‘**é™¤äº†å¯åº”ç”¨äºåŒºé—´ä¿®æ”¹ä¸åŒºé—´æ±‚å€¼ï¼Œè¿˜å¯ç”¨äºæ±‚åŒºé—´æœ€å€¼ï¼Œgcdç­‰ç­‰çš„é¢˜ç›®ï¼ŒåŒºé—´ä¿®æ”¹çš„æ–¹å¼ä¹Ÿå¤šç§å¤šæ ·ï¼Œç†Ÿç»ƒæŒæ¡åå³å¯ä¸¾ä¸€åä¸‰ã€‚

### ä¹˜æ³•

~~~c++
#include <iostream>
#define ll long long 
using namespace std;
int n, m, a[1000005], mod;

struct node {
	ll sum, l, r, mu, add;
}t[1000005];

ll read() {
	ll x = 0; char ch = getchar();
	while (ch < '0' || ch>'9')ch = getchar();
	while (ch >= '0' && ch <= '9')x = (x << 1) + (x << 3) + (ch ^ 48), ch = getchar();
	return x;
}

void build(ll p, ll l, ll r) {
	t[p].l = l, t[p].r = r; t[p].mu = 1;
	if (l == r) { 
		t[p].sum = a[l] % mod;
		return; 
	}
	ll mid = (l + r) >> 1;
	build(p * 2, l, mid);
	build(p * 2 + 1, mid + 1, r);
	t[p].sum = (t[p * 2].sum + t[p * 2 + 1].sum) % mod;
}

void spread(ll p) {
	t[p * 2].sum = (ll)(t[p].mu * t[p * 2].sum + ((t[p * 2].r - t[p * 2].l + 1) * t[p].add) % mod) % mod;
	t[p * 2 + 1].sum = (ll)(t[p].mu * t[p * 2 + 1].sum + (t[p].add * (t[p * 2 + 1].r - t[p * 2 + 1].l + 1)) % mod) % mod;//addå·²ç»ä¹˜è¿‡muå•¦

	t[p * 2].mu = (ll)(t[p * 2].mu * t[p].mu) % mod;
	t[p * 2 + 1].mu = (ll)(t[p * 2 + 1].mu * t[p].mu) % mod;

	t[p * 2].add = (ll)(t[p * 2].add * t[p].mu + t[p].add) % mod;
	t[p * 2 + 1].add = (ll)(t[p * 2 + 1].add * t[p].mu + t[p].add) % mod;

	t[p].mu = 1, t[p].add = 0;
}

void add(ll p, ll l, ll r, ll k) {
	if (t[p].l >= l && t[p].r <= r) {
		t[p].add = (t[p].add + k) % mod;
		t[p].sum = (ll)(t[p].sum + k * (t[p].r - t[p].l + 1)) % mod;
		return;
	}
	spread(p);
	t[p].sum = (t[p * 2].sum + t[p * 2 + 1].sum) % mod;
	ll mid = (t[p].l + t[p].r) >> 1;
	if (l <= mid)add(p * 2, l, r, k);
	if (mid < r)add(p * 2 + 1, l, r, k);
	t[p].sum = (t[p * 2].sum + t[p * 2 + 1].sum) % mod;

}

void mu(ll p, ll l, ll r, ll k) {
	if (t[p].l >= l && t[p].r <= r) {
		t[p].add = (t[p].add * k) % mod;
		t[p].mu = (t[p].mu * k) % mod;
		t[p].sum = (t[p].sum * k) % mod;
		return;
	}
	spread(p);
	t[p].sum = t[p * 2].sum + t[p * 2 + 1].sum;
	ll mid = (t[p].l + t[p].r) >> 1;
	if (l <= mid)mu(p * 2, l, r, k);
	if (mid < r)mu(p * 2 + 1, l, r, k);
	t[p].sum = (t[p * 2].sum + t[p * 2 + 1].sum) % mod;
}

ll ask(ll p, ll l, ll r) {
	if (t[p].l >= l && t[p].r <= r) {
		return t[p].sum;
	}
	spread(p);
	ll val = 0;
	ll mid = (t[p].l + t[p].r) >> 1;
	if (l <= mid)val = (val + ask(p * 2, l, r)) % mod;
	if (mid < r)val = (val + ask(p * 2 + 1, l, r)) % mod;
	return val;
}

int main() {
	cin >> n >> m >> mod;
	for (int i = 1; i <= n; i++) {
		a[i] = read();
	}
	build(1, 1, n);
	for (int i = 1; i <= m; i++) {
		int ty = read();
		if (ty == 1) {
			ll cn = read(), cm = read(), cw = read();
			mu(1, cn, cm, cw);
		}
		else if (ty == 2) {
			ll cn = read(), cm = read(), cw = read();
			add(1, cn, cm, cw);
		}
		else {
			ll cn = read(), cm = read();
			cout << ask(1, cn, cm) << endl;
		}
	}
}
~~~

### æœ€å¤§å­—æ®µå’Œ



---

## å¯æŒä¹…åŒ–çº¿æ®µæ ‘

ä¸‹é¢ç»™å‡ºæ´›è°·ä¸Šä¾‹é¢˜ï¼ˆ[P3919 ã€æ¨¡æ¿ã€‘å¯æŒä¹…åŒ–çº¿æ®µæ ‘ 1ï¼ˆå¯æŒä¹…åŒ–æ•°ç»„ï¼‰ - æ´›è°· ](https://www.luogu.com.cn/problem/P3919)ï¼‰çš„æ¿å­ï¼š

~~~c++
//std::ios::sync_with_stdio(false);
#include<bits/stdc++.h>
using namespace std;
const int MAXN = 1e6+10;
const int MAXM = 1e6+10;
const int mode = 2023;
const int INF = 0x7fffffff;
const long long inf = 1e18;
typedef long long ll;
const int dx[] = { -1,0,1,0 }, dy[] = { 0,1,0,-1 };
#define lowbit(x) x&(-x)
#define debug(x) cout<<"?"<<x<<"?\n";
inline int read()
{
    int x = 0, f = 1; char ch = getchar();
    while (ch < '0' || ch>'9') { if (ch == '-') f = -1; ch = getchar(); }
    while (ch >= '0' && ch <= '9') { x = x * 10 + ch - 48; ch = getchar(); }
    return x * f;
}

#define ls(x) tree[x].ls
#define rs(x) tree[x].rs
#define val(x) tree[x].val
#define mark(x) tree[x].mark
struct node
{
    ll val; int ls,rs;
}tree[MAXN*32];
int A[MAXN],roots[MAXN],n,m,cnt=1;
void build(int l=1,int r=n,int p=1)
{
    if(l==r) val(p)=A[l];
    else{
        ls(p)=++cnt,rs(p)=++cnt;
        int mid=(l+r)/2;
        build(l,mid,ls(p));
        build(mid+1,r,rs(p));
        val(p)=val(ls(p))+val(rs(p));
    }
}
//ä»¤xå˜æˆd, pè¡¨ç¤ºåŸæ¥ç‰ˆæœ¬çš„èŠ‚ç‚¹ï¼Œqè¡¨ç¤ºæ–°ç‰ˆæœ¬çš„èŠ‚ç‚¹
void update(int x,int d,int p,int q,int cl=1,int cr=n) //å•ç‚¹ä¿®æ”¹
{
    if(cl==cr) val(q)=d;
    else{
        ls(q)=ls(p),rs(q)=rs(p);
        int mid=(cl+cr)/2;
        if(x<=mid){
            ls(q)=++cnt;
            update(x,d,ls(p),ls(q),cl,mid);
        }
        else{
            rs(q)=++cnt;
            update(x,d,rs(p),rs(q),mid+1,cr);
        }
        val(q)=val(ls(q))+val(rs(q));
    }
}
int query(int l,int r,int p,int cl=1,int cr=n)
{
    if(cl>r||cr<l) return 0;
    else if(cl>=l&&cr<=r) return val(p);
    else{
        int mid=(cl+cr)/2;
        return query(l,r,ls(p),cl,mid)+query(l,r,rs(p),mid+1,cr);
    }
}

void solve()
{
    n=read(),m=read();
    for(int i=1;i<=n;++i)
    {
        A[i]=read();
    }
    build();
    roots[0]=1;
    for(int i=1;i<=m;++i)
    {
        int v=read(),o=read();
        if(o==1){
            int x=read(),d=read();
            roots[i]=++cnt;
            update(x,d,roots[v],roots[i]);
        }
        else{
            int x=read();
            roots[i]=roots[v];
            printf("%d\n",query(x,x,roots[v]));
        }
    }
}

int main()
{
    std::ios::sync_with_stdio(false);
    cin.tie(0);
    cout.tie(0);
    
    int t=1;
    //cin>>t;
    while(t--)
    {
        solve();
    }
    
    return 0;
}
~~~

## æ ‘ä¸Šçº¿æ®µæ ‘

### çº¿æ®µæ ‘+é‡é“¾å‰–åˆ†



# å•è°ƒæ ˆ

è°ƒæ ˆåˆ™ä¸»è¦ç”¨äº O(n) è§£å†³**NGEé—®é¢˜**ï¼ˆNext Greater Elementï¼‰ï¼Œä¹Ÿå°±æ˜¯ï¼Œå¯¹åºåˆ—ä¸­æ¯ä¸ªå…ƒç´ ï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ¯”å®ƒå¤§çš„å…ƒç´ ã€‚ï¼ˆå½“ç„¶ï¼Œâ€œä¸‹ä¸€ä¸ªâ€å¯ä»¥æ¢æˆâ€œä¸Šä¸€ä¸ªâ€ï¼Œâ€œæ¯”å®ƒå¤§â€ä¹Ÿå¯ä»¥æ¢æˆâ€œæ¯”ä»–å°â€ï¼ŒåŸç†ä¸å˜ï¼‰ã€‚
æˆ‘ä»¬ç»´æŠ¤ä¸€ä¸ªæ ˆï¼Œå…¶ä¸­å­˜çš„å†…å®¹æ˜¯â€œ**å¾…ç¡®å®šNGEçš„å…ƒç´ **â€ï¼Œç„¶åéå†åºåˆ—ã€‚æ¯ç¢°ä¸Šä¸€ä¸ªæ–°å…ƒç´ ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œæ ˆä¸­å…ƒç´ è¶Šé è¿‘æ ˆé¡¶çš„å…ƒç´ è·ç¦»æ–°å…ƒç´ è¶Šè¿‘ã€‚æ‰€ä»¥ä¸æ–­æ¯”è¾ƒæ ˆé¡¶å…ƒç´ ä¸æ–°å…ƒç´ ï¼Œå¦‚æœæ–°å…ƒç´ æ¯”æ ˆé¡¶å…ƒç´ å¤§ï¼Œåˆ™è¯´æ˜æ–°å…ƒç´ æ˜¯æ ˆé¡¶å…ƒç´ çš„NGEï¼Œç„¶åå¼¹å‡ºæ ˆé¡¶å…ƒç´ ä¸æ–­æ¯”è¾ƒã€‚ç›´åˆ°é‡åˆ°å…ƒç´ æ¯”æ–°å…ƒç´ å¤§æˆ–è€…æ ˆä¸ºç©ºï¼Œåˆ™å°†æ–°å…ƒç´ åŠ å…¥æ ˆä¸­ï¼Œç»§ç»­éå†ã€‚

**ä»£ç å®ç°**

~~~c++
#include <iostream>
#include <stack>
using namespace std;
const int MAXN = 3000300;

int n;
stack <int> sta;
int f[MAXN], ans[MAXN];

int main()
{
    ios::sync_with_stdio(false); 
	cin >> n;
	for (int i = 1; i <= n; i++) cin >> f[i];
	for (int i = 1; i <= n; i++) {
		while (!sta.empty() && f[sta.top()] < f[i]) {   //å¦‚æœæ ˆé¡¶å…ƒç´ æ¯”æ–°å…ƒç´ å°
			ans[sta.top()] = i;  //æ ˆé¡¶å…ƒç´ çš„NGEä¸ºæ–°å…ƒç´ 
			sta.pop();
		}
		sta.push(i);
	}
	for (int i = 1; i <= n; i++) cout << ans[i] << " ";
	return 0;
}
~~~

**ç›¸å…³ä¾‹é¢˜**

[P5788 ã€æ¨¡æ¿ã€‘å•è°ƒæ ˆ - æ´›è°· ](https://www.luogu.com.cn/problem/P5788)
[P1823 Patrik éŸ³ä¹ä¼šçš„ç­‰å¾… - æ´›è°· ](https://www.luogu.com.cn/problem/P1823)

## ç¦»çº¿è§£å†³ RMQ é—®é¢˜

â€‹	

# å•è°ƒé˜Ÿåˆ—

**å•è°ƒé˜Ÿåˆ—**ä¸»è¦ç”¨äºè§£å†³**æ»‘åŠ¨çª—å£**ç±»çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸²é•¿ä¸ºnçš„åºåˆ—ï¼Œæ±‚å…¶ä¸­æ¯ä¸ªé•¿åº¦ä¸ºmçš„åŒºé—´çš„æœ€å€¼ã€‚æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆnï¼‰ï¼Œå°äºSTè¡¨å’Œ[çº¿æ®µæ ‘](#Segment Tree)çš„Oï¼ˆnlognï¼‰ã€‚
å•è°ƒé˜Ÿåˆ—çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œç»´æŠ¤ä¸€ä¸ª**åŒå‘é˜Ÿåˆ—**ï¼ˆdequeï¼‰ï¼Œéå†åºåˆ—ï¼Œå½“ä¸€ä¸ªå…ƒç´ çš„å€¼å¯èƒ½æˆä¸ºåŒºé—´æœ€å€¼çš„æ—¶å€™ï¼Œæ‰å°†å®ƒå­˜å‚¨è¿›é˜Ÿåˆ—ä¸­ã€‚
|å¯ä»¥ç”¨**æ®‹é…·çš„ç®—æ³•ç«èµ›**æ¥ç±»æ¯”ã€‚å¦‚æœä¸€ä¸ªäººæ¯”ä½ å¹´è½»è¿˜æ¯”ä½ å¼ºï¼Œé‚£ä¹ˆä½ å°±æå‰æ¯•ä¸šäº†ã€‚

~~~c++
#include <iostream>
#include <queue>
using namespace std;

int n, m, a[MAXN];
deque <int> deq;

int main()
{
    cin >> n >> m;
    for (int i = 1; i <= n; i++) cin >> a[i];
    for (int i = 1; i <= n; i++) {
        if (!deq.empty() && deq.front() < i - m)  //æ­£å¸¸æ¯•ä¸š
            deq.pop_front();
        while (!deq.empty() && a[deq.back()] < a[i])  //è¢«è¿«æ¯•ä¸š
            deq.pop_back();
        deq.push_back(i); //æ–°ç”Ÿå…¥å­¦
    }
}
~~~



---

# åˆ†å—

